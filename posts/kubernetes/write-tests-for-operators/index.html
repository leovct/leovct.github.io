<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>üß™ Write tests for Kubernetes operators | leovct.dev</title>
<meta name="keywords" content="kubernetes, go, infra">
<meta name="description" content="Learn how to write unit and e2e tests for Kubernetes operators">
<meta name="author" content="leovct">
<link rel="canonical" href="https://leovct.github.io/posts/kubernetes/write-tests-for-operators/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3f99d1dd577ccb1acb5d04801b8eeed66b7ddafc3fdc5d9c02c96fbe418f1c37.css" integrity="sha256-P5nR3Vd8yxrLXQSAG47u1mt92vw/3F2cAslvvkGPHDc=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://leovct.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://leovct.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://leovct.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://leovct.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://leovct.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7BWGX7L5F0"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-7BWGX7L5F0', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="üß™ Write tests for Kubernetes operators" />
<meta property="og:description" content="Learn how to write unit and e2e tests for Kubernetes operators" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://leovct.github.io/posts/kubernetes/write-tests-for-operators/" />
<meta property="og:image" content="https://leovct.github.io/fig-1-cover.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-08-01T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://leovct.github.io/fig-1-cover.png" />
<meta name="twitter:title" content="üß™ Write tests for Kubernetes operators"/>
<meta name="twitter:description" content="Learn how to write unit and e2e tests for Kubernetes operators"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://leovct.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "üß™ Write tests for Kubernetes operators",
      "item": "https://leovct.github.io/posts/kubernetes/write-tests-for-operators/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "üß™ Write tests for Kubernetes operators",
  "name": "üß™ Write tests for Kubernetes operators",
  "description": "Learn how to write unit and e2e tests for Kubernetes operators",
  "keywords": [
    "kubernetes", "go", "infra"
  ],
  "articleBody": "You know how to build a kubernetes operator? Cool. Now, it‚Äôs time to get serious!\nLet‚Äôs write some tests to use our operator in production!\nIn my previous article, I showed how to build a Kubernetes operator in about ten minutes - but you must be quick haha! I‚Äôve also described the functioning of an operator, the custom resource definition and custom resources, the controllers, and the manager. If you want to learn more about these concepts, I highly recommend you read the article.\nBut now it‚Äôs time to write some tests to use our operator in production! It‚Äôs a subject in its own right that is less complicated than it seems. Most people don‚Äôt like writing tests, but they are necessary. They help to improve code quality, detect bugs, and save time and money. So, let‚Äôs do some testing!\nThe Different Types of Tests There are three major types of testing in software development: unit, integration, and end-to-end testing. It is even more complex than that in theory, but it gives an idea of what we‚Äôll see in this article.\nUnit tests are used to test small pieces of code, for example, methods or functions. Integration tests are used to test the integration of the different parts of an application. For example, the functioning of an operator in a Kubernetes environment with an API server and other resources. End-to-end tests, also known as e2e, aim to simulate a user‚Äôs step-by-step experience. They should cover the main functionalities of the application. In the practical work that follows, we‚Äôll see how to write unit tests in Go as well as integration tests for Kubernetes controllers. It‚Äôs interesting, you‚Äôll see! Practical Work 1. Set up your environment I choose to use the Kubebuilder framework to build Kubernetes operators. It‚Äôs very easy to use, the documentation is easy to read, and it‚Äôs a battle-tested product. It‚Äôs one of the two most popular Go frameworks to build operators, along with Operator SDK.\nI assume you already have the necessary tools to design an operator (go, docker, kubectl, kubebuilder and a small local Kubernetes cluster). But if this is not the case, I strongly recommend that you follow the following installation steps so that you can follow along with me during this tutorial.\nTo focus only on the testing part, I have prepared a simple Kubernetes operator, designed with Kubebuilder. This practical work will be to write tests to validate that the operator‚Äôs code meets our expectations and ensure that it does not contain any bugs. I‚Äôm going to ask you to clone the project and move to the operator-v2 branch so we all start from the same base.\n$ git clone git@github.com:leovct/kubernetes-operator-tutorial.git \u0026\u0026 \\ cd kubernetes-operator-tutorial \u0026\u0026 \\ git checkout operator-v2 \u0026\u0026 \\ git pull origin operator-v2 If you try to run tests, you‚Äôll see that the coverage equals 0%. Indeed, we haven‚Äôt written any tests yet! But this is going to change!\n$ make test mkdir -p /Users/leovct/Documents/tutorial/bin GOBIN=/Users/leovct/Documents/tutorial/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.8.0 /Users/leovct/Documents/tutorial/bin/controller-gen rbac:roleName=manager-role crd webhook paths=\"./...\" output:crd:artifacts:config=config/crd/bases /Users/leovct/Documents/tutorial/bin/controller-gen object:headerFile=\"hack/boilerplate.go.txt\" paths=\"./...\" go fmt ./... go vet ./... GOBIN=/Users/leovct/Documents/tutorial/bin go install sigs.k8s.io/controller-runtime/tools/setup-envtest@latest KUBEBUILDER_ASSETS=\"/Users/leovct/Library/Application Support/io.kubebuilder.envtest/k8s/1.23.5-darwin-amd64\" go test ./... -coverprofile cover.out ? my.domain/tutorial [no test files] ? my.domain/tutorial/api/v1 [no test files] ? my.domain/tutorial/color [no test files] ok my.domain/tutorial/controllers 6.220s coverage: 0.0% of statements 2. Some context on the operator The ‚ÄúFoo‚Äù operator you cloned is similar to the one I built in my ‚ÄúBuild a Kubernetes Operator in 10 minutes‚Äù article. It has no real purpose except to show how you can use operators to perform simple tasks in Kubernetes.\nHow does the operator work?\nBecause a diagram explains ideas way better than three paragraphs, here it is.\nFig 2. Overview of the operator‚Äôs functioning\nFirst, there is the Foo Custom Resource Definition or CRD (see api/v1/foo_types.go). It has a name field in its specification which refers to the name of the friend Foo is looking for. If Foo finds a friend (a Pod with the same name as his friend), its happy status will be set to true. A small addition since the previous tutorial, the status of Foo also contains a color field, determined according to its name and the namespace in which it evolves.\nSecond, there is the Foo Controller (see controllers/foo_controller.go). It fetches the Foo resource that triggered the reconciliation request to get the name of Foo‚Äôs friend. Then, it lists all the pods with the same name as Foo‚Äôs friend. If at least one friend has been found, it updates Foo‚Äôs happy status to true, else we set it to false. It also updates Foo‚Äôs color status.\nNote that the controller also reacts to Pod events (see mapPodsReqToFooReq). Indeed, if a new pod is created, we want the Foo resource to be able to update its status accordingly. This method will be triggered each time a Pod event happens (creation, update, or deletion). It then triggers a reconciliation loop of the Foo controller only if the Pod‚Äôs name is a ‚Äúfriend‚Äù of one of the Foo custom resources deployed in the cluster.\nNow that we know how the operator works, we can get on with testing it.\n3. Unit tests At this stage, we will test small pieces of code like methods and functions. Of course, we won‚Äôt test the controller Reconcile method here because it involves setting up a testing Kubernetes environment with a local Kubernetes API server, the CRD, the controller, the manager, etc. We‚Äôll see this in the 4. Integration tests section instead.\nWhat are we going to test then? If you take the time to read the code of the Foo controller, you‚Äôll notice that I use the ConvertStrToColor function from the color package to update Foo‚Äôs color status. Let‚Äôs write the unit tests of this simple method!\nOur goal here is to make sure that the function returns what is expected given the input parameters. Here are the three tests I‚Äôd like to write to test this function:\nConvert an empty string to a colour of the colour wheel. Convert a short string to a colour of the colour wheel. Convert a very long string (with numbers and dashes) to a colour of the colour wheel. To write unit tests in Go, you create a list of tests describing the name, input parameters and expected result. Then you run a loop and compare the function‚Äôs output with the expected result. Here is my test function to check that ConvertStrToColor works correctly:\nNow, if you attempt to run the tests a second time, you‚Äôll see that the code coverage of the color package is equal to 100%! Awesome, we did it! The function works as expected.\n$ make test /Users/leovct/Documents/tutorial/bin/controller-gen rbac:roleName=manager-role crd webhook paths=\"./...\" output:crd:artifacts:config=config/crd/bases /Users/leovct/Documents/tutorial/bin/controller-gen object:headerFile=\"hack/boilerplate.go.txt\" paths=\"./...\" go fmt ./... go vet ./... KUBEBUILDER_ASSETS=\"/Users/leovct/Library/Application Support/io.kubebuilder.envtest/k8s/1.23.5-darwin-amd64\" go test ./... -coverprofile cover.out ? my.domain/tutorial [no test files] ? my.domain/tutorial/api/v1 [no test files] ok my.domain/tutorial/color 0.306s coverage: 100.0% of statements ok my.domain/tutorial/controllers 6.626s coverage: 0.0% of statements Now, let‚Äôs get down to business. We‚Äôre going to test how the operator‚Äôs reconciliation loop! Trust me, this is the most interesting part of the article!\n4. Integration tests Kubebuilder provided a test boilerplate (see controllers/suite_test.go) that sets up a testing environment with a local Kubernetes API server. The only thing we need to do is first instantiate and run the controller and then write tests with Ginkgo (framework used by Kubebuilder) to verify that our operator behaves well when it evolves in a Kubernetes environment.\nOf course, this test environment is very simple and often does not represent the environment of a production cluster. This is why running the operator‚Äôs tests in an existing cluster is also possible to get closer to a real production environment. You can learn more about that here.\nFirst, we‚Äôll need to instantiate and start the Foo controller. To do this, we need to create another client. Why do we need two clients? Because when running tests, you want to assert against the live state of the API server. If you use the client from the manager in your tests, you‚Äôd end up asserting against the content of the cache instead. First, this is slower. Second, this can introduce flaws. That‚Äôs why we‚Äôve got two clients: k8sclient, the client we‚Äôll use in our tests, and k8sManager.getClient(), the manager‚Äôs client.\nHere is the modified source code of the test environment setup.\nNow that our test environment is properly set up, we can write integration tests! Let‚Äôs create a new test file called foo_controller_test.go under the controllers folder. In this file, we‚Äôll define our tests using the Ginkgo framework. Here‚Äôs a simple test example that creates two Foo custom resources and ensures that the resources have been created.\nGreat! Now let‚Äôs write a test that creates a pod with the same name as one of the Foo custom resources‚Äô friends. The controller should update the status of the custom resource and set it to true. The other custom resource should still have its status set to false.\nLet‚Äôs write another test that updates the name of the second Foo custom resource‚Äôs friend to the name of the previously created pod. The controller should update the status of the custom resource and set it to true. Again, the other custom resource should still have its status set to false.\nOur final test for today will be to delete the pod we created and check that the controller updates the status of all the custom resources to false.\nThese are fairly simple tests, but they show you the possibilities. You can do very complex things using the various tools provided by Ginkgo. If you paid attention during the tutorial, you should have seen various instructions such as Expect, Eventually, or Consistently, which are very useful methods to test the behaviour of the operator and the resources running in Kubernetes.\nWe‚Äôve written many great tests that cover our controller‚Äôs scope. Now it‚Äôs time to run them to see if the operator passes them all.\n$ make test /Users/leovct/Documents/tutorial/bin/controller-gen rbac:roleName=manager-role crd webhook paths=\"./...\" output:crd:artifacts:config=config/crd/bases /Users/leovct/Documents/tutorial/bin/controller-gen object:headerFile=\"hack/boilerplate.go.txt\" paths=\"./...\" go fmt ./... go vet ./... KUBEBUILDER_ASSETS=\"/Users/leovct/Library/Application Support/io.kubebuilder.envtest/k8s/1.23.5-darwin-amd64\" go test ./... -coverprofile cover.out ? my.domain/tutorial [no test files] ? my.domain/tutorial/api/v1 [no test files] ok my.domain/tutorial/color 0.077s coverage: 100.0% of statements ok my.domain/tutorial/controllers 8.434s coverage: 82.4% of statements Nice, we‚Äôve got no errors! In addition, we went from 0% coverage to over 82%! The last 18% corresponds to the parts of the code that we can‚Äôt test (or maybe using mocks but it would be a lot of work for not much). For example, when the controller can‚Äôt find the custom resource that triggered the reconciliation loop or when it can‚Äôt list the pods in the cluster. It doesn‚Äôt matter because we know that we have tested all the operator‚Äôs scope.\nHere‚Äôs the link to the GitHub repository if you need to browse the code. The operator-v2 branch contains the source code of the operator without the tests, while the tests branch contains the source code with all the tests.\nTo Go Further We‚Äôve seen how to write unit tests and integration tests for Kubernetes controllers using the Ginkgo framework. It is a crucial step in developing Kubernetes operators as it allows for validating the correct functioning of the reconciliation logic.\nAlso, here‚Äôs a list of resources you can use to dig deeper into the subject.\nhttps://book.kubebuilder.io/cronjob-tutorial/writing-tests.html https://book.kubebuilder.io/reference/envtest.html http://onsi.github.io/ginkgo Have fun! :)\nNB: This article was published on Medium in Better Programming, you can find it here.\n",
  "wordCount" : "1911",
  "inLanguage": "en",
  "image":"https://leovct.github.io/fig-1-cover.png","datePublished": "2022-08-01T00:00:00Z",
  "dateModified": "2022-08-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "leovct"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://leovct.github.io/posts/kubernetes/write-tests-for-operators/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "leovct.dev",
    "logo": {
      "@type": "ImageObject",
      "url": "https://leovct.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://leovct.github.io/" accesskey="h" title="leovct.dev (Alt + H)">leovct.dev</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://leovct.github.io/search/" title="search (Alt &#43; /)" accesskey=/>
                    <span>search</span>
                </a>
            </li>
            <li>
                <a href="https://leovct.github.io/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
            <li>
                <a href="https://leovct.github.io/archives/" title="archives">
                    <span>archives</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      üß™ Write tests for Kubernetes operators
    </h1>
    <div class="post-description">
      Learn how to write unit and e2e tests for Kubernetes operators
    </div>
    <div class="post-meta"><span title='2022-08-01 00:00:00 +0000 UTC'>August 1, 2022</span>&nbsp;¬∑&nbsp;9 min&nbsp;¬∑&nbsp;1911 words&nbsp;¬∑&nbsp;leovct&nbsp;|&nbsp;<a href="https://github.com/leovct/leovct.github.io/tree/main/content//posts/kubernetes/write-tests-for-operators/index.md" rel="noopener noreferrer" target="_blank">üìù Suggest changes</a>

</div>
  </header> 
<figure class="entry-cover">
        <img loading="lazy" srcset="https://leovct.github.io/posts/kubernetes/write-tests-for-operators/fig-1-cover_hu2c29bb60f63a48c7b4f4ab3536236250_2398987_360x0_resize_box_3.png 360w ,https://leovct.github.io/posts/kubernetes/write-tests-for-operators/fig-1-cover_hu2c29bb60f63a48c7b4f4ab3536236250_2398987_480x0_resize_box_3.png 480w ,https://leovct.github.io/posts/kubernetes/write-tests-for-operators/fig-1-cover_hu2c29bb60f63a48c7b4f4ab3536236250_2398987_720x0_resize_box_3.png 720w ,https://leovct.github.io/posts/kubernetes/write-tests-for-operators/fig-1-cover_hu2c29bb60f63a48c7b4f4ab3536236250_2398987_1080x0_resize_box_3.png 1080w ,https://leovct.github.io/posts/kubernetes/write-tests-for-operators/fig-1-cover_hu2c29bb60f63a48c7b4f4ab3536236250_2398987_1500x0_resize_box_3.png 1500w ,https://leovct.github.io/posts/kubernetes/write-tests-for-operators/fig-1-cover.png 1920w" 
            sizes="(min-width: 768px) 720px, 100vw" src="https://leovct.github.io/posts/kubernetes/write-tests-for-operators/fig-1-cover.png" alt="Fig 1. Photo from [Unsplash](https://unsplash.com/photos/aYHzEnSEH-w)" 
            width="1920" height="1280">
        <p>Fig 1. Photo from <a href="https://unsplash.com/photos/aYHzEnSEH-w">Unsplash</a></p>
</figure><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#the-different-types-of-tests" aria-label="The Different Types of Tests">The Different Types of Tests</a></li>
                <li>
                    <a href="#practical-work" aria-label="Practical Work">Practical Work</a><ul>
                        
                <li>
                    <a href="#1-set-up-your-environment" aria-label="1. Set up your environment">1. Set up your environment</a></li>
                <li>
                    <a href="#2-some-context-on-the-operator" aria-label="2. Some context on the operator">2. Some context on the operator</a></li>
                <li>
                    <a href="#3-unit-tests" aria-label="3. Unit tests">3. Unit tests</a></li>
                <li>
                    <a href="#4-integration-tests" aria-label="4. Integration tests">4. Integration tests</a></li></ul>
                </li>
                <li>
                    <a href="#to-go-further" aria-label="To Go Further">To Go Further</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>You know how to build a kubernetes operator? Cool. Now, it‚Äôs time to get serious!</p>
<p>Let&rsquo;s write some tests to use our operator in production!</p>
<p>In my previous <a href="https://leovct.github.io/posts/build-a-kubernetes-operator-in-10-minutes/">article</a>, I showed how to build a Kubernetes operator in about ten minutes - but you must be quick haha! I‚Äôve also described the functioning of an operator, the custom resource definition and custom resources, the controllers, and the manager. If you want to learn more about these concepts, I highly recommend you read the article.</p>
<p>But now it‚Äôs time to write some tests to use our operator in production! It‚Äôs a subject in its own right that is less complicated than it seems. Most people don‚Äôt like writing tests, but they are necessary. They help to improve code quality, detect bugs, and save time and money. So, let‚Äôs do some testing!</p>
<h2 id="the-different-types-of-tests">The Different Types of Tests<a hidden class="anchor" aria-hidden="true" href="#the-different-types-of-tests">#</a></h2>
<p>There are three major types of testing in software development: unit, integration, and end-to-end testing. It is even more complex than that in theory, but it gives an idea of what we‚Äôll see in this article.</p>
<ul>
<li><strong>Unit tests</strong> are used to test small pieces of code, for example, methods or functions.</li>
<li><strong>Integration tests</strong> are used to test the integration of the different parts of an application. For example, the functioning of an operator in a Kubernetes environment with an API server and other resources.</li>
<li><strong>End-to-end tests</strong>, also known as e2e, aim to simulate a user‚Äôs step-by-step experience. They should cover the main functionalities of the application. In the practical work that follows, we‚Äôll see how to write unit tests in Go as well as integration tests for Kubernetes controllers. It‚Äôs interesting, you‚Äôll see!</li>
</ul>
<h2 id="practical-work">Practical Work<a hidden class="anchor" aria-hidden="true" href="#practical-work">#</a></h2>
<h3 id="1-set-up-your-environment">1. Set up your environment<a hidden class="anchor" aria-hidden="true" href="#1-set-up-your-environment">#</a></h3>
<p>I choose to use the <a href="https://book.kubebuilder.io/">Kubebuilder</a> framework to build Kubernetes operators. It‚Äôs very easy to use, the documentation is easy to read, and it‚Äôs a battle-tested product. It‚Äôs one of the two most popular Go frameworks to build operators, along with <a href="https://sdk.operatorframework.io/">Operator SDK</a>.</p>
<p>I assume you already have the necessary tools to design an operator (<code>go</code>, <code>docker</code>, <code>kubectl</code>, <code>kubebuilder</code> and a small local Kubernetes cluster). But if this is not the case, I strongly recommend that you follow the following <a href="https://leovct.github.io/posts/build-a-kubernetes-operator-in-10-minutes/#1-set-up-your-environment">installation steps</a> so that you can follow along with me during this tutorial.</p>
<p>To focus only on the testing part, I have prepared a simple Kubernetes operator, designed with Kubebuilder. This practical work will be to write tests to validate that the operator‚Äôs code meets our expectations and ensure that it does not contain any bugs. I‚Äôm going to ask you to clone the project and move to the <code>operator-v2</code> branch so we all start from the same base.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ git clone git@github.com:leovct/kubernetes-operator-tutorial.git <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    cd kubernetes-operator-tutorial <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    git checkout operator-v2 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    git pull origin operator-v2
</span></span></code></pre></div><p>If you try to run tests, you‚Äôll see that the coverage equals 0%. Indeed, we haven‚Äôt written any tests yet! But this is going to change!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ make test
</span></span><span style="display:flex;"><span>mkdir -p /Users/leovct/Documents/tutorial/bin
</span></span><span style="display:flex;"><span>GOBIN<span style="color:#f92672">=</span>/Users/leovct/Documents/tutorial/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.8.0
</span></span><span style="display:flex;"><span>/Users/leovct/Documents/tutorial/bin/controller-gen rbac:roleName<span style="color:#f92672">=</span>manager-role crd webhook paths<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./...&#34;</span> output:crd:artifacts:config<span style="color:#f92672">=</span>config/crd/bases
</span></span><span style="display:flex;"><span>/Users/leovct/Documents/tutorial/bin/controller-gen object:headerFile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hack/boilerplate.go.txt&#34;</span> paths<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./...&#34;</span>
</span></span><span style="display:flex;"><span>go fmt ./...
</span></span><span style="display:flex;"><span>go vet ./...
</span></span><span style="display:flex;"><span>GOBIN<span style="color:#f92672">=</span>/Users/leovct/Documents/tutorial/bin go install sigs.k8s.io/controller-runtime/tools/setup-envtest@latest
</span></span><span style="display:flex;"><span>KUBEBUILDER_ASSETS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Users/leovct/Library/Application Support/io.kubebuilder.envtest/k8s/1.23.5-darwin-amd64&#34;</span> go test ./... -coverprofile cover.out
</span></span><span style="display:flex;"><span>?       my.domain/tutorial      <span style="color:#f92672">[</span>no test files<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>?       my.domain/tutorial/api/v1       <span style="color:#f92672">[</span>no test files<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>?       my.domain/tutorial/color        <span style="color:#f92672">[</span>no test files<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ok      my.domain/tutorial/controllers  6.220s  coverage: 0.0% of statements
</span></span></code></pre></div><h3 id="2-some-context-on-the-operator">2. Some context on the operator<a hidden class="anchor" aria-hidden="true" href="#2-some-context-on-the-operator">#</a></h3>
<p>The ‚ÄúFoo‚Äù operator you cloned is similar to the one I built in my ‚Äú<a href="https://leovct.github.io/posts/build-a-kubernetes-operator-in-10-minutes/">Build a Kubernetes Operator in 10 minutes</a>‚Äù article. It has no real purpose except to show how you can use operators to perform simple tasks in Kubernetes.</p>
<p>How does the operator work?</p>
<p>Because a diagram explains ideas way better than three paragraphs, here it is.</p>
<figure class="align-center ">
    <img loading="lazy" src="fig-2-foo-operator-overview.png#center"
         alt="Fig 2. Overview of the operator&amp;rsquo;s functioning" width="600" height="300"/> <figcaption>
            <p>Fig 2. Overview of the operator&rsquo;s functioning</p>
        </figcaption>
</figure>

<p>First, there is the Foo Custom Resource Definition or CRD (see <code>api/v1/foo_types.go</code>). It has a <code>name</code> field in its specification which refers to the name of the friend Foo is looking for. If Foo finds a friend (a Pod with the same name as his friend), its <code>happy</code> status will be set to <code>true</code>. A small addition since the previous tutorial, the status of Foo also contains a <code>color</code> field, determined according to its name and the namespace in which it evolves.</p>
<p>Second, there is the Foo Controller (see <code>controllers/foo_controller.go</code>). It fetches the Foo resource that triggered the reconciliation request to get the name of Foo‚Äôs friend. Then, it lists all the pods with the same name as Foo‚Äôs friend. If at least one friend has been found, it updates Foo‚Äôs <code>happy</code> status to <code>true</code>, else we set it to <code>false</code>. It also updates Foo‚Äôs <code>color</code> status.</p>
<p>Note that the controller also reacts to Pod events (see <code>mapPodsReqToFooReq</code>). Indeed, if a new pod is created, we want the Foo resource to be able to update its status accordingly. This method will be triggered each time a Pod event happens (creation, update, or deletion). It then triggers a reconciliation loop of the Foo controller only if the Pod&rsquo;s name is a ‚Äúfriend‚Äù of one of the Foo custom resources deployed in the cluster.</p>
<p>Now that we know how the operator works, we can get on with testing it.</p>
<h3 id="3-unit-tests">3. Unit tests<a hidden class="anchor" aria-hidden="true" href="#3-unit-tests">#</a></h3>
<p>At this stage, we will test small pieces of code like methods and functions. Of course, we won‚Äôt test the controller <code>Reconcile</code> method here because it involves setting up a testing Kubernetes environment with a local Kubernetes API server, the CRD, the controller, the manager, etc. We‚Äôll see this in the 4. Integration tests section instead.</p>
<p>What are we going to test then? If you take the time to read the code of the Foo controller, you‚Äôll notice that I use the <code>ConvertStrToColor</code> function from the <code>color</code> package to update Foo‚Äôs <code>color</code> status. Let‚Äôs write the unit tests of this simple method!</p>
<script type="application/javascript" src="https://gist.github.com/leovct/786b5c520dbbfaa60d16b5897b0532fb.js"></script>

<p>Our goal here is to make sure that the function returns what is expected given the input parameters. Here are the three tests I‚Äôd like to write to test this function:</p>
<ol>
<li>Convert an empty string to a colour of the colour wheel.</li>
<li>Convert a short string to a colour of the colour wheel.</li>
<li>Convert a very long string (with numbers and dashes) to a colour of the colour wheel.</li>
</ol>
<p>To write unit tests in Go, you create a list of tests describing the name, input parameters and expected result. Then you run a loop and compare the function&rsquo;s output with the expected result. Here is my test function to check that <code>ConvertStrToColor</code> works correctly:</p>
<script type="application/javascript" src="https://gist.github.com/leovct/e0d7563e278c1a4d25ea3e823d3515aa.js"></script>

<p>Now, if you attempt to run the tests a second time, you‚Äôll see that the code coverage of the <code>color</code> package is equal to 100%! Awesome, we did it! The function works as expected.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ make test
</span></span><span style="display:flex;"><span>/Users/leovct/Documents/tutorial/bin/controller-gen rbac:roleName<span style="color:#f92672">=</span>manager-role crd webhook paths<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./...&#34;</span> output:crd:artifacts:config<span style="color:#f92672">=</span>config/crd/bases
</span></span><span style="display:flex;"><span>/Users/leovct/Documents/tutorial/bin/controller-gen object:headerFile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hack/boilerplate.go.txt&#34;</span> paths<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./...&#34;</span>
</span></span><span style="display:flex;"><span>go fmt ./...
</span></span><span style="display:flex;"><span>go vet ./...
</span></span><span style="display:flex;"><span>KUBEBUILDER_ASSETS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Users/leovct/Library/Application Support/io.kubebuilder.envtest/k8s/1.23.5-darwin-amd64&#34;</span> go test ./... -coverprofile cover.out
</span></span><span style="display:flex;"><span>?       my.domain/tutorial      <span style="color:#f92672">[</span>no test files<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>?       my.domain/tutorial/api/v1       <span style="color:#f92672">[</span>no test files<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ok      my.domain/tutorial/color        0.306s  coverage: 100.0% of statements
</span></span><span style="display:flex;"><span>ok      my.domain/tutorial/controllers  6.626s  coverage: 0.0% of statements
</span></span></code></pre></div><p>Now, let‚Äôs get down to business. We‚Äôre going to test how the operator‚Äôs reconciliation loop! Trust me, this is the most interesting part of the article!</p>
<h3 id="4-integration-tests">4. Integration tests<a hidden class="anchor" aria-hidden="true" href="#4-integration-tests">#</a></h3>
<p>Kubebuilder provided a test boilerplate (see <code>controllers/suite_test.go</code>) that sets up a testing environment with a local Kubernetes API server. The only thing we need to do is first instantiate and run the controller and then write tests with <a href="https://onsi.github.io/ginkgo/">Ginkgo</a> (framework used by Kubebuilder) to verify that our operator behaves well when it evolves in a Kubernetes environment.</p>
<p>Of course, this test environment is very simple and often does not represent the environment of a production cluster. This is why running the operator‚Äôs tests in an existing cluster is also possible to get closer to a real production environment. You can learn more about that <a href="https://book.kubebuilder.io/reference/envtest.html">here</a>.</p>
<p>First, we‚Äôll need to instantiate and start the Foo controller. To do this, we need to create another client. Why do we need two clients? Because when running tests, you want to assert against the live state of the API server. If you use the client from the manager in your tests, you‚Äôd end up asserting against the content of the cache instead. First, this is slower. Second, this can introduce flaws. That‚Äôs why we‚Äôve got two clients: <code>k8sclient</code>, the client we‚Äôll use in our tests, and <code>k8sManager.getClient()</code>, the manager&rsquo;s client.</p>
<p>Here is the modified source code of the test environment setup.</p>
<script type="application/javascript" src="https://gist.github.com/leovct/47dceaf7d524ae7be9850ad8ae02b791.js"></script>

<p>Now that our test environment is properly set up, we can write integration tests! Let‚Äôs create a new test file called <code>foo_controller_test.go</code> under the <code>controllers</code> folder. In this file, we‚Äôll define our tests using the Ginkgo framework. Here‚Äôs a simple test example that creates two Foo custom resources and ensures that the resources have been created.</p>
<script type="application/javascript" src="https://gist.github.com/leovct/025628faea88b93c561f490d2a1e51f2.js"></script>

<p>Great! Now let‚Äôs write a test that creates a pod with the same name as one of the Foo custom resources‚Äô friends. The controller should update the status of the custom resource and set it to <code>true</code>. The other custom resource should still have its status set to <code>false</code>.</p>
<script type="application/javascript" src="https://gist.github.com/leovct/b65dcf88ae6218f1d9fa7e7cc1d6502a.js"></script>

<p>Let‚Äôs write another test that updates the name of the second Foo custom resource‚Äôs friend to the name of the previously created pod. The controller should update the status of the custom resource and set it to <code>true</code>. Again, the other custom resource should still have its status set to <code>false</code>.</p>
<script type="application/javascript" src="https://gist.github.com/leovct/0f7398a6facaf18451a91ce68891cf8f.js"></script>

<p>Our final test for today will be to delete the pod we created and check that the controller updates the status of all the custom resources to <code>false</code>.</p>
<script type="application/javascript" src="https://gist.github.com/leovct/d1d2c55cdd54bce15312807940d76217.js"></script>

<p>These are fairly simple tests, but they show you the possibilities. You can do very complex things using the various tools provided by Ginkgo. If you paid attention during the tutorial, you should have seen various instructions such as <code>Expect</code>, <code>Eventually</code>, or <code>Consistently</code>, which are very useful methods to test the behaviour of the operator and the resources running in Kubernetes.</p>
<p>We‚Äôve written many great tests that cover our controller&rsquo;s scope. Now it‚Äôs time to run them to see if the operator passes them all.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ make test
</span></span><span style="display:flex;"><span>/Users/leovct/Documents/tutorial/bin/controller-gen rbac:roleName<span style="color:#f92672">=</span>manager-role crd webhook paths<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./...&#34;</span> output:crd:artifacts:config<span style="color:#f92672">=</span>config/crd/bases
</span></span><span style="display:flex;"><span>/Users/leovct/Documents/tutorial/bin/controller-gen object:headerFile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hack/boilerplate.go.txt&#34;</span> paths<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./...&#34;</span>
</span></span><span style="display:flex;"><span>go fmt ./...
</span></span><span style="display:flex;"><span>go vet ./...
</span></span><span style="display:flex;"><span>KUBEBUILDER_ASSETS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Users/leovct/Library/Application Support/io.kubebuilder.envtest/k8s/1.23.5-darwin-amd64&#34;</span> go test ./... -coverprofile cover.out
</span></span><span style="display:flex;"><span>?    my.domain/tutorial <span style="color:#f92672">[</span>no test files<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>?    my.domain/tutorial/api/v1 <span style="color:#f92672">[</span>no test files<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ok   my.domain/tutorial/color 0.077s coverage: 100.0% of statements
</span></span><span style="display:flex;"><span>ok   my.domain/tutorial/controllers 8.434s coverage: 82.4% of statements
</span></span></code></pre></div><p>Nice, we‚Äôve got no errors! In addition, we went from 0% coverage to over 82%! The last 18% corresponds to the parts of the code that we can‚Äôt test (or maybe using mocks but it would be a lot of work for not much). For example, when the controller can‚Äôt find the custom resource that triggered the reconciliation loop or when it can‚Äôt list the pods in the cluster. It doesn‚Äôt matter because we know that we have tested all the operator‚Äôs scope.</p>
<p>Here‚Äôs the link to the <a href="https://github.com/leovct/kubernetes-operator-tutorial">GitHub repository</a> if you need to browse the code. The <code>operator-v2 branch</code> contains the source code of the operator without the tests, while the tests branch contains the source code with all the tests.</p>
<h2 id="to-go-further">To Go Further<a hidden class="anchor" aria-hidden="true" href="#to-go-further">#</a></h2>
<p>We‚Äôve seen how to write unit tests and integration tests for Kubernetes controllers using the Ginkgo framework. It is a crucial step in developing Kubernetes operators as it allows for validating the correct functioning of the reconciliation logic.</p>
<p>Also, here‚Äôs a list of resources you can use to dig deeper into the subject.</p>
<ul>
<li><a href="https://book.kubebuilder.io/cronjob-tutorial/writing-tests.html">https://book.kubebuilder.io/cronjob-tutorial/writing-tests.html</a></li>
<li><a href="https://book.kubebuilder.io/reference/envtest.html">https://book.kubebuilder.io/reference/envtest.html</a></li>
<li><a href="http://onsi.github.io/ginkgo">http://onsi.github.io/ginkgo</a></li>
</ul>
<p>Have fun! :)</p>
<p><em>NB: This article was published on Medium in Better Programming, you can find it <a href="https://medium.com/better-programming/write-tests-for-your-kubernetes-operator-d3d6a9530840">here</a></em>.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://leovct.github.io/tags/kubernetes/">kubernetes</a></li>
      <li><a href="https://leovct.github.io/tags/go/">go</a></li>
      <li><a href="https://leovct.github.io/tags/infra/">infra</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://leovct.github.io/">leovct.dev</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
